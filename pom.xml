<?xml version="1.0" encoding="UTF-8"?>

<!--
  POM Maven pédagogique
  =====================
  Objectif :
  - Compiler une application Java 21
  - Exécuter des tests
  - Produire un JAR exécutable
  - Copier les dépendances dans target/libs
  - Être facilement utilisable avec Docker
-->

<project xmlns="http://maven.apache.org/POM/4.0.0"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

    <!-- Version du modèle Maven (toujours 4.0.0) -->
    <modelVersion>4.0.0</modelVersion>

    <!-- Coordonnées du projet -->
    <groupId>fr.univtln.bruno.demos.docker</groupId>
    <artifactId>hello-java</artifactId>
    <version>0.1.0-SNAPSHOT</version>

    <name>Hello Java</name>
    <description>
        Application Java "Hello World" utilisée pour démontrer Maven et Docker
    </description>

    <!-- ===================================================== -->
    <!-- Propriétés                                           -->
    <!-- ===================================================== -->
    <!--
      Bonne pratique :
      - Centraliser toutes les versions
      - Faciliter les mises à jour
      - Éviter les valeurs "en dur"
    -->
    <properties>

        <!-- Encodage -->
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF-8</project.reporting.outputEncoding>

        <!-- Version de Java -->
        <java.version>21</java.version>

        <!-- Classe principale de l'application -->
        <main.class>app.App1</main.class>

        <!-- Dépendances -->
        <junit.version>5.11.4</junit.version>
        <slf4j.version>2.0.16</slf4j.version>
        <logback.version>1.5.16</logback.version>

        <!-- Plugins Maven -->
        <maven.compiler.version>3.13.0</maven.compiler.version>
        <maven.surefire.version>3.5.2</maven.surefire.version>
        <maven.jar.version>3.4.2</maven.jar.version>
        <maven.dependency.version>3.6.1</maven.dependency.version>
        <versions.maven.version>2.21.0</versions.maven.version>

    </properties>

    <!-- ===================================================== -->
    <!-- Dépendances                                          -->
    <!-- ===================================================== -->
    <dependencies>

        <!-- ======================= -->
        <!-- Dépendances de test     -->
        <!-- ======================= -->
        <dependency>
            <groupId>org.junit.jupiter</groupId>
            <artifactId>junit-jupiter</artifactId>
            <version>${junit.version}</version>
            <scope>test</scope>
        </dependency>

        <!-- ======================= -->
        <!-- Logging (runtime)       -->
        <!-- ======================= -->

        <!-- API de logging (abstraction) -->
        <dependency>
            <groupId>org.slf4j</groupId>
            <artifactId>slf4j-api</artifactId>
            <version>${slf4j.version}</version>
        </dependency>

        <!-- Implémentation concrète -->
        <dependency>
            <groupId>ch.qos.logback</groupId>
            <artifactId>logback-classic</artifactId>
            <version>${logback.version}</version>
        </dependency>

    </dependencies>

    <!-- ===================================================== -->
    <!-- Build                                                 -->
    <!-- ===================================================== -->
    <build>

        <plugins>

            <!-- ======================= -->
            <!-- Compilation Java        -->
            <!-- ======================= -->
            <plugin>
                <artifactId>maven-compiler-plugin</artifactId>
                <version>${maven.compiler.version}</version>
                <configuration>
                    <!-- Utilisation du mode release (bonne pratique) -->
                    <release>${java.version}</release>

                    <!-- Conserve les noms des paramètres (utile pour frameworks) -->
                    <parameters>true</parameters>
                </configuration>
            </plugin>

            <!-- ======================= -->
            <!-- Exécution des tests     -->
            <!-- ======================= -->
            <plugin>
                <artifactId>maven-surefire-plugin</artifactId>
                <version>${maven.surefire.version}</version>
            </plugin>

        <!-- ======================= -->
        <!-- Gestion des versions    -->
        <!-- ======================= -->
        <plugin>
            <!-- Plugin de maintenance (NON exécuté automatiquement) -->
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>versions-maven-plugin</artifactId>
            <version>${versions.maven.version}</version>

            <configuration>
                <rulesUri>
                    https://bruno.univ-tln.fr/rules.xml
                </rulesUri>
            </configuration>
        </plugin>

        </plugins>

    </build>

    <!-- ===================================================== -->
    <!-- Profils Maven                                        -->
    <!-- ===================================================== -->
    <!--
      Un profil = un mode de build
      Ici :
      - default : développement
      - prod    : production / Docker
    -->
    <profiles>

        <!-- ================================================= -->
        <!-- Profil production                                 -->
        <!-- ================================================= -->
        <profile>
            <id>prod</id>

            <build>
                <plugins>

                    <!-- ========================================= -->
                    <!-- Copier les dépendances dans target/libs    -->
                    <!-- ========================================= -->
                    <!--
                      Résultat :
                      target/
                        ├── hello-java-XXX.jar
                        └── libs/
                            ├── logback.jar
                            └── slf4j.jar
                    -->
                    <plugin>
                        <artifactId>maven-dependency-plugin</artifactId>
                        <version>${maven.dependency.version}</version>
                        <executions>
                            <execution>
                                <id>copy-dependencies</id>
                                <phase>package</phase>
                                <goals>
                                    <goal>copy-dependencies</goal>
                                </goals>
                                <configuration>
                                    <outputDirectory>
                                        ${project.build.directory}/libs
                                    </outputDirectory>
                                    <includeScope>runtime</includeScope>
                                </configuration>
                            </execution>
                        </executions>
                    </plugin>

                    <!-- ========================================= -->
                    <!-- Création du JAR exécutable                 -->
                    <!-- ========================================= -->
                    <!--
                      Le MANIFEST.MF contiendra :
                      - Main-Class
                      - Class-Path: libs/...
                    -->
                    <plugin>
                        <artifactId>maven-jar-plugin</artifactId>
                        <version>${maven.jar.version}</version>
                        <configuration>
                            <archive>
                                <manifest>
                                    <mainClass>${main.class}</mainClass>
                                    <addClasspath>true</addClasspath>
                                    <classpathPrefix>libs/</classpathPrefix>
                                </manifest>

                                <!-- Infos utiles pour le debug -->
                                <manifestEntries>
                                    <Built-By>${user.name}</Built-By>
                                    <Build-Jdk>${java.version}</Build-Jdk>
                                    <Build-Time>${maven.build.timestamp}</Build-Time>
                                </manifestEntries>
                            </archive>
                        </configuration>
                    </plugin>

                </plugins>
            </build>
        </profile>

    </profiles>

</project>
